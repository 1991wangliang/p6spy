<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>P6SpyDriverCore xref</title>
<link type="text/css" rel="stylesheet" href="../../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../../apidocs/com/p6spy/engine/spy/P6SpyDriverCore.html">View Javadoc</a></div><pre>

<a class="jxr_linenumber" name="1" href="#1">1</a>   <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="2" href="#2">2</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="3" href="#3">3</a>   <em class="jxr_comment"> * ====================================================================</em>
<a class="jxr_linenumber" name="4" href="#4">4</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="5" href="#5">5</a>   <em class="jxr_comment"> * The P6Spy Software License, Version 1.1</em>
<a class="jxr_linenumber" name="6" href="#6">6</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="7" href="#7">7</a>   <em class="jxr_comment"> * This license is derived and fully compatible with the Apache Software</em>
<a class="jxr_linenumber" name="8" href="#8">8</a>   <em class="jxr_comment"> * license, see <a href="http://www.apache.org/LICENSE.txt" target="alexandria_uri">http://www.apache.org/LICENSE.txt</a></em>
<a class="jxr_linenumber" name="9" href="#9">9</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="10" href="#10">10</a>  <em class="jxr_comment"> * Copyright (c) 2001-2002 Andy Martin, Ph.D. and Jeff Goke</em>
<a class="jxr_linenumber" name="11" href="#11">11</a>  <em class="jxr_comment"> * All rights reserved.</em>
<a class="jxr_linenumber" name="12" href="#12">12</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="13" href="#13">13</a>  <em class="jxr_comment"> * Redistribution and use in source and binary forms, with or without</em>
<a class="jxr_linenumber" name="14" href="#14">14</a>  <em class="jxr_comment"> * modification, are permitted provided that the following conditions</em>
<a class="jxr_linenumber" name="15" href="#15">15</a>  <em class="jxr_comment"> * are met:</em>
<a class="jxr_linenumber" name="16" href="#16">16</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="17" href="#17">17</a>  <em class="jxr_comment"> * 1. Redistributions of source code must retain the above copyright</em>
<a class="jxr_linenumber" name="18" href="#18">18</a>  <em class="jxr_comment"> * notice, this list of conditions and the following disclaimer.</em>
<a class="jxr_linenumber" name="19" href="#19">19</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="20" href="#20">20</a>  <em class="jxr_comment"> * 2. Redistributions in binary form must reproduce the above copyright</em>
<a class="jxr_linenumber" name="21" href="#21">21</a>  <em class="jxr_comment"> * notice, this list of conditions and the following disclaimer in</em>
<a class="jxr_linenumber" name="22" href="#22">22</a>  <em class="jxr_comment"> * the documentation and/or other materials provided with the</em>
<a class="jxr_linenumber" name="23" href="#23">23</a>  <em class="jxr_comment"> * distribution.</em>
<a class="jxr_linenumber" name="24" href="#24">24</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="25" href="#25">25</a>  <em class="jxr_comment"> * 3. The end-user documentation included with the redistribution, if</em>
<a class="jxr_linenumber" name="26" href="#26">26</a>  <em class="jxr_comment"> * any, must include the following acknowlegement:</em>
<a class="jxr_linenumber" name="27" href="#27">27</a>  <em class="jxr_comment"> * "The original concept and code base for P6Spy was conceived</em>
<a class="jxr_linenumber" name="28" href="#28">28</a>  <em class="jxr_comment"> * and developed by Andy Martin, Ph.D. who generously contribued</em>
<a class="jxr_linenumber" name="29" href="#29">29</a>  <em class="jxr_comment"> * the first complete release to the public under this license.</em>
<a class="jxr_linenumber" name="30" href="#30">30</a>  <em class="jxr_comment"> * This product was due to the pioneering work of Andy</em>
<a class="jxr_linenumber" name="31" href="#31">31</a>  <em class="jxr_comment"> * that began in December of 1995 developing applications that could</em>
<a class="jxr_linenumber" name="32" href="#32">32</a>  <em class="jxr_comment"> * seamlessly be deployed with minimal effort but with dramatic results.</em>
<a class="jxr_linenumber" name="33" href="#33">33</a>  <em class="jxr_comment"> * This code is maintained and extended by Jeff Goke and with the ideas</em>
<a class="jxr_linenumber" name="34" href="#34">34</a>  <em class="jxr_comment"> * and contributions of other P6Spy contributors.</em>
<a class="jxr_linenumber" name="35" href="#35">35</a>  <em class="jxr_comment"> * (<a href="http://www.p6spy.com)" target="alexandria_uri">http://www.p6spy.com)</a>"</em>
<a class="jxr_linenumber" name="36" href="#36">36</a>  <em class="jxr_comment"> * Alternately, this acknowlegement may appear in the software itself,</em>
<a class="jxr_linenumber" name="37" href="#37">37</a>  <em class="jxr_comment"> * if and wherever such third-party acknowlegements normally appear.</em>
<a class="jxr_linenumber" name="38" href="#38">38</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="39" href="#39">39</a>  <em class="jxr_comment"> * 4. The names "P6Spy", "Jeff Goke", and "Andy Martin" must not be used</em>
<a class="jxr_linenumber" name="40" href="#40">40</a>  <em class="jxr_comment"> * to endorse or promote products derived from this software without</em>
<a class="jxr_linenumber" name="41" href="#41">41</a>  <em class="jxr_comment"> * prior written permission. For written permission, please contact</em>
<a class="jxr_linenumber" name="42" href="#42">42</a>  <em class="jxr_comment"> * license@p6spy.com.</em>
<a class="jxr_linenumber" name="43" href="#43">43</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="44" href="#44">44</a>  <em class="jxr_comment"> * 5. Products derived from this software may not be called "P6Spy"</em>
<a class="jxr_linenumber" name="45" href="#45">45</a>  <em class="jxr_comment"> * nor may "P6Spy" appear in their names without prior written</em>
<a class="jxr_linenumber" name="46" href="#46">46</a>  <em class="jxr_comment"> * permission of Jeff Goke and Andy Martin.</em>
<a class="jxr_linenumber" name="47" href="#47">47</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="48" href="#48">48</a>  <em class="jxr_comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED</em>
<a class="jxr_linenumber" name="49" href="#49">49</a>  <em class="jxr_comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</em>
<a class="jxr_linenumber" name="50" href="#50">50</a>  <em class="jxr_comment"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</em>
<a class="jxr_linenumber" name="51" href="#51">51</a>  <em class="jxr_comment"> * DISCLAIMED. IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR</em>
<a class="jxr_linenumber" name="52" href="#52">52</a>  <em class="jxr_comment"> * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</em>
<a class="jxr_linenumber" name="53" href="#53">53</a>  <em class="jxr_comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</em>
<a class="jxr_linenumber" name="54" href="#54">54</a>  <em class="jxr_comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF</em>
<a class="jxr_linenumber" name="55" href="#55">55</a>  <em class="jxr_comment"> * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</em>
<a class="jxr_linenumber" name="56" href="#56">56</a>  <em class="jxr_comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</em>
<a class="jxr_linenumber" name="57" href="#57">57</a>  <em class="jxr_comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</em>
<a class="jxr_linenumber" name="58" href="#58">58</a>  <em class="jxr_comment"> * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</em>
<a class="jxr_linenumber" name="59" href="#59">59</a>  <em class="jxr_comment"> * SUCH DAMAGE.</em>
<a class="jxr_linenumber" name="60" href="#60">60</a>  <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="61" href="#61">61</a>  
<a class="jxr_linenumber" name="62" href="#62">62</a>  <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="63" href="#63">63</a>  <em class="jxr_javadoccomment"> * Description: Wrapper class for Driver</em>
<a class="jxr_linenumber" name="64" href="#64">64</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="65" href="#65">65</a>  <em class="jxr_javadoccomment"> * $Author: cheechq $</em>
<a class="jxr_linenumber" name="66" href="#66">66</a>  <em class="jxr_javadoccomment"> * $Revision: 1.15 $</em>
<a class="jxr_linenumber" name="67" href="#67">67</a>  <em class="jxr_javadoccomment"> * $Date: 2003/06/03 19:20:26 $</em>
<a class="jxr_linenumber" name="68" href="#68">68</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="69" href="#69">69</a>  <em class="jxr_javadoccomment"> * $Id: P6SpyDriverCore.java,v 1.15 2003/06/03 19:20:26 cheechq Exp $</em>
<a class="jxr_linenumber" name="70" href="#70">70</a>  <em class="jxr_javadoccomment"> * $Log: P6SpyDriverCore.java,v $</em>
<a class="jxr_linenumber" name="71" href="#71">71</a>  <em class="jxr_javadoccomment"> * Revision 1.15  2003/06/03 19:20:26  cheechq</em>
<a class="jxr_linenumber" name="72" href="#72">72</a>  <em class="jxr_javadoccomment"> * removed unused imports</em>
<a class="jxr_linenumber" name="73" href="#73">73</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="74" href="#74">74</a>  <em class="jxr_javadoccomment"> * Revision 1.14  2003/04/10 18:17:57  aarvesen</em>
<a class="jxr_linenumber" name="75" href="#75">75</a>  <em class="jxr_javadoccomment"> * always check to see if there are drivers to dereg.  Then, either deregister them or warn that they'll prevent you from functioning properly</em>
<a class="jxr_linenumber" name="76" href="#76">76</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="77" href="#77">77</a>  <em class="jxr_javadoccomment"> * Revision 1.13  2003/03/07 22:08:09  aarvesen</em>
<a class="jxr_linenumber" name="78" href="#78">78</a>  <em class="jxr_javadoccomment"> * added deregistration code</em>
<a class="jxr_linenumber" name="79" href="#79">79</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="80" href="#80">80</a>  <em class="jxr_javadoccomment"> * Revision 1.12  2003/02/24 17:56:28  dlukeparker</em>
<a class="jxr_linenumber" name="81" href="#81">81</a>  <em class="jxr_javadoccomment"> * Removed debug output</em>
<a class="jxr_linenumber" name="82" href="#82">82</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="83" href="#83">83</a>  <em class="jxr_javadoccomment"> * Revision 1.11  2003/02/24 17:45:05  dlukeparker</em>
<a class="jxr_linenumber" name="84" href="#84">84</a>  <em class="jxr_javadoccomment"> * Clarified error reporting when spy.properties is not found</em>
<a class="jxr_linenumber" name="85" href="#85">85</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="86" href="#86">86</a>  <em class="jxr_javadoccomment"> * Revision 1.10  2003/01/28 19:32:31  jeffgoke</em>
<a class="jxr_linenumber" name="87" href="#87">87</a>  <em class="jxr_javadoccomment"> * fixed bug exposed by test framework where option reloading was having problems if options were manipulated before the driver was created.</em>
<a class="jxr_linenumber" name="88" href="#88">88</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="89" href="#89">89</a>  <em class="jxr_javadoccomment"> * Revision 1.9  2003/01/28 17:01:13  jeffgoke</em>
<a class="jxr_linenumber" name="90" href="#90">90</a>  <em class="jxr_javadoccomment"> * rewrote options to the ability for a module to have its own option set</em>
<a class="jxr_linenumber" name="91" href="#91">91</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="92" href="#92">92</a>  <em class="jxr_javadoccomment"> * Revision 1.8  2003/01/18 00:26:35  jeffgoke</em>
<a class="jxr_linenumber" name="93" href="#93">93</a>  <em class="jxr_javadoccomment"> * fixed a bug where new instances of the driver (not using driver manager but creating instances of the driver yourself) were causing the connection to be null</em>
<a class="jxr_linenumber" name="94" href="#94">94</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="95" href="#95">95</a>  <em class="jxr_javadoccomment"> * Revision 1.7  2003/01/16 00:50:03  jeffgoke</em>
<a class="jxr_linenumber" name="96" href="#96">96</a>  <em class="jxr_javadoccomment"> * changed Error call to use syntax compatible prior to 1.4</em>
<a class="jxr_linenumber" name="97" href="#97">97</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="98" href="#98">98</a>  <em class="jxr_javadoccomment"> * Revision 1.6  2003/01/15 22:11:52  aarvesen</em>
<a class="jxr_linenumber" name="99" href="#99">99</a>  <em class="jxr_javadoccomment"> * do some stronger error trapping and die on error</em>
<a class="jxr_linenumber" name="100" href="#100">100</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="101" href="#101">101</a> <em class="jxr_javadoccomment"> * Revision 1.5  2003/01/10 21:40:11  jeffgoke</em>
<a class="jxr_linenumber" name="102" href="#102">102</a> <em class="jxr_javadoccomment"> * changed to use new error handling facility</em>
<a class="jxr_linenumber" name="103" href="#103">103</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="104" href="#104">104</a> <em class="jxr_javadoccomment"> * Revision 1.4  2003/01/03 21:18:03  aarvesen</em>
<a class="jxr_linenumber" name="105" href="#105">105</a> <em class="jxr_javadoccomment"> * use the new P6Util.forName</em>
<a class="jxr_linenumber" name="106" href="#106">106</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="107" href="#107">107</a> <em class="jxr_javadoccomment"> * Revision 1.3  2002/12/20 00:04:09  aarvesen</em>
<a class="jxr_linenumber" name="108" href="#108">108</a> <em class="jxr_javadoccomment"> * New style of driver!</em>
<a class="jxr_linenumber" name="109" href="#109">109</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="110" href="#110">110</a> <em class="jxr_javadoccomment"> * Revision 1.2  2002/10/06 18:23:25  jeffgoke</em>
<a class="jxr_linenumber" name="111" href="#111">111</a> <em class="jxr_javadoccomment"> * no message</em>
<a class="jxr_linenumber" name="112" href="#112">112</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="113" href="#113">113</a> <em class="jxr_javadoccomment"> * Revision 1.1  2002/05/24 07:31:13  jeffgoke</em>
<a class="jxr_linenumber" name="114" href="#114">114</a> <em class="jxr_javadoccomment"> * version 1 rewrite</em>
<a class="jxr_linenumber" name="115" href="#115">115</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="116" href="#116">116</a> <em class="jxr_javadoccomment"> * Revision 1.1  2002/05/16 04:58:40  jeffgoke</em>
<a class="jxr_linenumber" name="117" href="#117">117</a> <em class="jxr_javadoccomment"> * Viktor Szathmary added multi-driver support.</em>
<a class="jxr_linenumber" name="118" href="#118">118</a> <em class="jxr_javadoccomment"> * Rewrote P6SpyOptions to be easier to manage.</em>
<a class="jxr_linenumber" name="119" href="#119">119</a> <em class="jxr_javadoccomment"> * Fixed several bugs.</em>
<a class="jxr_linenumber" name="120" href="#120">120</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="121" href="#121">121</a> <em class="jxr_javadoccomment"> * Revision 1.6  2002/05/05 00:43:00  jeffgoke</em>
<a class="jxr_linenumber" name="122" href="#122">122</a> <em class="jxr_javadoccomment"> * Added Philip's reload code.</em>
<a class="jxr_linenumber" name="123" href="#123">123</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="124" href="#124">124</a> <em class="jxr_javadoccomment"> * Revision 1.5  2002/04/15 05:13:32  jeffgoke</em>
<a class="jxr_linenumber" name="125" href="#125">125</a> <em class="jxr_javadoccomment"> * Simon Sadedin added timing support.  Fixed bug where batch execute was not</em>
<a class="jxr_linenumber" name="126" href="#126">126</a> <em class="jxr_javadoccomment"> * getting logged.  Added result set timing.  Updated the log format to include</em>
<a class="jxr_linenumber" name="127" href="#127">127</a> <em class="jxr_javadoccomment"> * categories, and updated options to control the categories.  Updated</em>
<a class="jxr_linenumber" name="128" href="#128">128</a> <em class="jxr_javadoccomment"> * documentation.</em>
<a class="jxr_linenumber" name="129" href="#129">129</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="130" href="#130">130</a> <em class="jxr_javadoccomment"> * Revision 1.4  2002/04/10 06:49:26  jeffgoke</em>
<a class="jxr_linenumber" name="131" href="#131">131</a> <em class="jxr_javadoccomment"> * added more debug information and a new property for setting the log's date format</em>
<a class="jxr_linenumber" name="132" href="#132">132</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="133" href="#133">133</a> <em class="jxr_javadoccomment"> * Revision 1.3  2002/04/10 05:22:09  jeffgoke</em>
<a class="jxr_linenumber" name="134" href="#134">134</a> <em class="jxr_javadoccomment"> * included debug option and a message at driver initialization time</em>
<a class="jxr_linenumber" name="135" href="#135">135</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="136" href="#136">136</a> <em class="jxr_javadoccomment"> * Revision 1.2  2002/04/07 20:43:59  jeffgoke</em>
<a class="jxr_linenumber" name="137" href="#137">137</a> <em class="jxr_javadoccomment"> * fixed bug that caused null connection to return an empty connection instead of null.</em>
<a class="jxr_linenumber" name="138" href="#138">138</a> <em class="jxr_javadoccomment"> * added an option allowing the user to truncate.</em>
<a class="jxr_linenumber" name="139" href="#139">139</a> <em class="jxr_javadoccomment"> * added a release target to the build to create the release files.</em>
<a class="jxr_linenumber" name="140" href="#140">140</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="141" href="#141">141</a> <em class="jxr_javadoccomment"> * Revision 1.1.1.1  2002/04/07 04:52:25  jeffgoke</em>
<a class="jxr_linenumber" name="142" href="#142">142</a> <em class="jxr_javadoccomment"> * no message</em>
<a class="jxr_linenumber" name="143" href="#143">143</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="144" href="#144">144</a> <em class="jxr_javadoccomment"> * Revision 1.3  2001-08-02 07:52:44-05  andy</em>
<a class="jxr_linenumber" name="145" href="#145">145</a> <em class="jxr_javadoccomment"> * &lt;&gt;</em>
<a class="jxr_linenumber" name="146" href="#146">146</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="147" href="#147">147</a> <em class="jxr_javadoccomment"> * Revision 1.2  2001-07-30 23:37:33-05  andy</em>
<a class="jxr_linenumber" name="148" href="#148">148</a> <em class="jxr_javadoccomment"> * &lt;&gt;</em>
<a class="jxr_linenumber" name="149" href="#149">149</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="150" href="#150">150</a> <em class="jxr_javadoccomment"> * Revision 1.1  2001-07-30 23:03:31-05  andy</em>
<a class="jxr_linenumber" name="151" href="#151">151</a> <em class="jxr_javadoccomment"> * &lt;&gt;</em>
<a class="jxr_linenumber" name="152" href="#152">152</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="153" href="#153">153</a> <em class="jxr_javadoccomment"> * Revision 1.0  2001-07-30 17:46:23-05  andy</em>
<a class="jxr_linenumber" name="154" href="#154">154</a> <em class="jxr_javadoccomment"> * Initial revision</em>
<a class="jxr_linenumber" name="155" href="#155">155</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="156" href="#156">156</a> <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="157" href="#157">157</a> 
<a class="jxr_linenumber" name="158" href="#158">158</a> <strong class="jxr_keyword">package</strong> com.p6spy.engine.spy;
<a class="jxr_linenumber" name="159" href="#159">159</a> 
<a class="jxr_linenumber" name="160" href="#160">160</a> <strong class="jxr_keyword">import</strong> com.p6spy.engine.common.OptionReloader;
<a class="jxr_linenumber" name="161" href="#161">161</a> <strong class="jxr_keyword">import</strong> com.p6spy.engine.common.P6LogQuery;
<a class="jxr_linenumber" name="162" href="#162">162</a> <strong class="jxr_keyword">import</strong> com.p6spy.engine.common.P6Options;
<a class="jxr_linenumber" name="163" href="#163">163</a> <strong class="jxr_keyword">import</strong> com.p6spy.engine.common.P6SpyOptions;
<a class="jxr_linenumber" name="164" href="#164">164</a> <strong class="jxr_keyword">import</strong> com.p6spy.engine.common.P6SpyProperties;
<a class="jxr_linenumber" name="165" href="#165">165</a> <strong class="jxr_keyword">import</strong> com.p6spy.engine.common.P6Util;
<a class="jxr_linenumber" name="166" href="#166">166</a> 
<a class="jxr_linenumber" name="167" href="#167">167</a> <strong class="jxr_keyword">import</strong> java.sql.Connection;
<a class="jxr_linenumber" name="168" href="#168">168</a> <strong class="jxr_keyword">import</strong> java.sql.Driver;
<a class="jxr_linenumber" name="169" href="#169">169</a> <strong class="jxr_keyword">import</strong> java.sql.DriverManager;
<a class="jxr_linenumber" name="170" href="#170">170</a> <strong class="jxr_keyword">import</strong> java.sql.DriverPropertyInfo;
<a class="jxr_linenumber" name="171" href="#171">171</a> <strong class="jxr_keyword">import</strong> java.sql.SQLException;
<a class="jxr_linenumber" name="172" href="#172">172</a> <strong class="jxr_keyword">import</strong> java.sql.SQLFeatureNotSupportedException;
<a class="jxr_linenumber" name="173" href="#173">173</a> <strong class="jxr_keyword">import</strong> java.util.ArrayList;
<a class="jxr_linenumber" name="174" href="#174">174</a> <strong class="jxr_keyword">import</strong> java.util.Enumeration;
<a class="jxr_linenumber" name="175" href="#175">175</a> <strong class="jxr_keyword">import</strong> java.util.Iterator;
<a class="jxr_linenumber" name="176" href="#176">176</a> <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="177" href="#177">177</a> <strong class="jxr_keyword">import</strong> java.util.concurrent.CopyOnWriteArrayList;
<a class="jxr_linenumber" name="178" href="#178">178</a> <strong class="jxr_keyword">import</strong> java.util.logging.Logger;
<a class="jxr_linenumber" name="179" href="#179">179</a> 
<a class="jxr_linenumber" name="180" href="#180">180</a> <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> <strong class="jxr_keyword">class</strong> <a href="../../../../com/p6spy/engine/spy/P6SpyDriverCore.html">P6SpyDriverCore</a> <strong class="jxr_keyword">implements</strong> Driver {
<a class="jxr_linenumber" name="181" href="#181">181</a> 
<a class="jxr_linenumber" name="182" href="#182">182</a>     <strong class="jxr_keyword">protected</strong> Driver passthru;
<a class="jxr_linenumber" name="183" href="#183">183</a> 
<a class="jxr_linenumber" name="184" href="#184">184</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">boolean</strong> initialized;
<a class="jxr_linenumber" name="185" href="#185">185</a> 
<a class="jxr_linenumber" name="186" href="#186">186</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> List&lt;P6Factory&gt; factories;
<a class="jxr_linenumber" name="187" href="#187">187</a> 
<a class="jxr_linenumber" name="188" href="#188">188</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> List&lt;Driver&gt; realDrivers = <strong class="jxr_keyword">new</strong> CopyOnWriteArrayList&lt;Driver&gt;();
<a class="jxr_linenumber" name="189" href="#189">189</a> 
<a class="jxr_linenumber" name="190" href="#190">190</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">boolean</strong> foundSpyProperties;
<a class="jxr_linenumber" name="191" href="#191">191</a> 
<a class="jxr_linenumber" name="192" href="#192">192</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="193" href="#193">193</a> <em class="jxr_comment">     * This core class serves to purposes</em>
<a class="jxr_linenumber" name="194" href="#194">194</a> <em class="jxr_comment">     *</em>
<a class="jxr_linenumber" name="195" href="#195">195</a> <em class="jxr_comment">     * (1) it acts as a bootstap class the first time</em>
<a class="jxr_linenumber" name="196" href="#196">196</a> <em class="jxr_comment">     * it is invoked and it loads not itself, but the first driver on the stack.  This is</em>
<a class="jxr_linenumber" name="197" href="#197">197</a> <em class="jxr_comment">     * important because P6SpyDriver, P6SpyDriver2, etc. extend this class and performs</em>
<a class="jxr_linenumber" name="198" href="#198">198</a> <em class="jxr_comment">     * the initial bootstrap</em>
<a class="jxr_linenumber" name="199" href="#199">199</a> <em class="jxr_comment">     *</em>
<a class="jxr_linenumber" name="200" href="#200">200</a> <em class="jxr_comment">     * (2) when connect or acceptURL are invoked it ensures it has a passthru driver.</em>
<a class="jxr_linenumber" name="201" href="#201">201</a> <em class="jxr_comment">     *</em>
<a class="jxr_linenumber" name="202" href="#202">202</a> <em class="jxr_comment">     *</em>
<a class="jxr_linenumber" name="203" href="#203">203</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="204" href="#204">204</a> 
<a class="jxr_linenumber" name="205" href="#205">205</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">synchronized</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> initMethod(String spydriver) {
<a class="jxr_linenumber" name="206" href="#206">206</a>         <em class="jxr_comment">// this is the *only* p6 driver</em>
<a class="jxr_linenumber" name="207" href="#207">207</a>         <em class="jxr_comment">// we need to build two lists here:</em>
<a class="jxr_linenumber" name="208" href="#208">208</a>         <em class="jxr_comment">// one of the modules that are loaded, and one of the</em>
<a class="jxr_linenumber" name="209" href="#209">209</a>         <em class="jxr_comment">// realdriver(s) that we need</em>
<a class="jxr_linenumber" name="210" href="#210">210</a> 
<a class="jxr_linenumber" name="211" href="#211">211</a>         <em class="jxr_comment">// these are defined outside the try block for error messaging</em>
<a class="jxr_linenumber" name="212" href="#212">212</a> 
<a class="jxr_linenumber" name="213" href="#213">213</a>         <strong class="jxr_keyword">if</strong> (initialized) {
<a class="jxr_linenumber" name="214" href="#214">214</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="215" href="#215">215</a>         }
<a class="jxr_linenumber" name="216" href="#216">216</a> 
<a class="jxr_linenumber" name="217" href="#217">217</a>         <em class="jxr_comment">// first thing we want to do is load the core options file, but</em>
<a class="jxr_linenumber" name="218" href="#218">218</a>         <em class="jxr_comment">// we don't know where it is, so find out, then set up to throw</em>
<a class="jxr_linenumber" name="219" href="#219">219</a>         <em class="jxr_comment">// an exception from the constructor if it cannot be found.</em>
<a class="jxr_linenumber" name="220" href="#220">220</a>         String path = P6SpyProperties.getPropertiesPath();
<a class="jxr_linenumber" name="221" href="#221">221</a>         <strong class="jxr_keyword">if</strong> (path == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="222" href="#222">222</a>             foundSpyProperties = false;
<a class="jxr_linenumber" name="223" href="#223">223</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="224" href="#224">224</a>         }
<a class="jxr_linenumber" name="225" href="#225">225</a> 
<a class="jxr_linenumber" name="226" href="#226">226</a>         foundSpyProperties = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="227" href="#227">227</a> 
<a class="jxr_linenumber" name="228" href="#228">228</a>         <a href="../../../../com/p6spy/engine/common/P6SpyProperties.html">P6SpyProperties</a> properties = <strong class="jxr_keyword">new</strong> <a href="../../../../com/p6spy/engine/common/P6SpyProperties.html">P6SpyProperties</a>();
<a class="jxr_linenumber" name="229" href="#229">229</a>         <a href="../../../../com/p6spy/engine/common/P6SpyOptions.html">P6SpyOptions</a> coreOptions = <strong class="jxr_keyword">new</strong> <a href="../../../../com/p6spy/engine/common/P6SpyOptions.html">P6SpyOptions</a>();
<a class="jxr_linenumber" name="230" href="#230">230</a>         OptionReloader.add(coreOptions, properties);
<a class="jxr_linenumber" name="231" href="#231">231</a> 
<a class="jxr_linenumber" name="232" href="#232">232</a>         <em class="jxr_comment">// now register the core options file with the reloader</em>
<a class="jxr_linenumber" name="233" href="#233">233</a> 
<a class="jxr_linenumber" name="234" href="#234">234</a>         String className = <span class="jxr_string">"no class"</span>;
<a class="jxr_linenumber" name="235" href="#235">235</a>         String classType = <span class="jxr_string">"driver"</span>;
<a class="jxr_linenumber" name="236" href="#236">236</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="237" href="#237">237</a>             List&lt;String&gt; driverNames = P6SpyOptions.allDriverNames();
<a class="jxr_linenumber" name="238" href="#238">238</a>             List modules = P6SpyOptions.allModules();
<a class="jxr_linenumber" name="239" href="#239">239</a> 
<a class="jxr_linenumber" name="240" href="#240">240</a>             <strong class="jxr_keyword">boolean</strong> hasModules = modules.size() &gt; 0;
<a class="jxr_linenumber" name="241" href="#241">241</a> 
<a class="jxr_linenumber" name="242" href="#242">242</a> 
<a class="jxr_linenumber" name="243" href="#243">243</a>             <em class="jxr_comment">// register drivers and wrappers</em>
<a class="jxr_linenumber" name="244" href="#244">244</a>             classType = <span class="jxr_string">"driver"</span>;
<a class="jxr_linenumber" name="245" href="#245">245</a>             <strong class="jxr_keyword">for</strong> (String driverName : driverNames) {
<a class="jxr_linenumber" name="246" href="#246">246</a>                 <a href="../../../../com/p6spy/engine/spy/P6SpyDriver.html">P6SpyDriver</a> spy = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="247" href="#247">247</a>                 <em class="jxr_comment">// register P6 first if you are using it</em>
<a class="jxr_linenumber" name="248" href="#248">248</a>                 <strong class="jxr_keyword">if</strong> (hasModules) {
<a class="jxr_linenumber" name="249" href="#249">249</a>                     spy = <strong class="jxr_keyword">new</strong> <a href="../../../../com/p6spy/engine/spy/P6SpyDriver.html">P6SpyDriver</a>();
<a class="jxr_linenumber" name="250" href="#250">250</a>                     DriverManager.registerDriver(spy);
<a class="jxr_linenumber" name="251" href="#251">251</a>                 }
<a class="jxr_linenumber" name="252" href="#252">252</a> 
<a class="jxr_linenumber" name="253" href="#253">253</a>                 <em class="jxr_comment">// this is bogus, but we need to make *sure*</em>
<a class="jxr_linenumber" name="254" href="#254">254</a>                 <em class="jxr_comment">// that p6 is registered before your real drivers.  Otherwise</em>
<a class="jxr_linenumber" name="255" href="#255">255</a>                 <em class="jxr_comment">// the real driver will intercept the call before p6 gets it.</em>
<a class="jxr_linenumber" name="256" href="#256">256</a>                 <em class="jxr_comment">// so, deregister the driver if nec.</em>
<a class="jxr_linenumber" name="257" href="#257">257</a>                 className = driverName;
<a class="jxr_linenumber" name="258" href="#258">258</a>                 deregister(className);
<a class="jxr_linenumber" name="259" href="#259">259</a>                 Driver realDriver = (Driver) P6Util.forName(className).newInstance();
<a class="jxr_linenumber" name="260" href="#260">260</a>                 <strong class="jxr_keyword">if</strong> (P6SpyOptions.getDeregisterDrivers()) {
<a class="jxr_linenumber" name="261" href="#261">261</a>                     <em class="jxr_comment">// just in case you had to deregister</em>
<a class="jxr_linenumber" name="262" href="#262">262</a>                     DriverManager.registerDriver(realDriver);
<a class="jxr_linenumber" name="263" href="#263">263</a>                 }
<a class="jxr_linenumber" name="264" href="#264">264</a> 
<a class="jxr_linenumber" name="265" href="#265">265</a>                 <em class="jxr_comment">// now wrap your realDriver in the spy</em>
<a class="jxr_linenumber" name="266" href="#266">266</a>                 <strong class="jxr_keyword">if</strong> (hasModules) {
<a class="jxr_linenumber" name="267" href="#267">267</a>                     spy.setPassthru(realDriver);
<a class="jxr_linenumber" name="268" href="#268">268</a>                     realDrivers.add(realDriver);
<a class="jxr_linenumber" name="269" href="#269">269</a>                 }
<a class="jxr_linenumber" name="270" href="#270">270</a> 
<a class="jxr_linenumber" name="271" href="#271">271</a>                 P6LogQuery.debug(<span class="jxr_string">"Registered driver: "</span> + className + <span class="jxr_string">", realdriver: "</span> + realDriver);
<a class="jxr_linenumber" name="272" href="#272">272</a>             }
<a class="jxr_linenumber" name="273" href="#273">273</a> 
<a class="jxr_linenumber" name="274" href="#274">274</a>             <em class="jxr_comment">// instantiate the factories, if nec.</em>
<a class="jxr_linenumber" name="275" href="#275">275</a>             <strong class="jxr_keyword">if</strong> (hasModules) {
<a class="jxr_linenumber" name="276" href="#276">276</a>                 factories = <strong class="jxr_keyword">new</strong> CopyOnWriteArrayList&lt;P6Factory&gt;();
<a class="jxr_linenumber" name="277" href="#277">277</a>                 classType = <span class="jxr_string">"factory"</span>;
<a class="jxr_linenumber" name="278" href="#278">278</a> 
<a class="jxr_linenumber" name="279" href="#279">279</a>                 <strong class="jxr_keyword">for</strong> (Iterator&lt;String&gt; i = modules.iterator();i.hasNext();) {
<a class="jxr_linenumber" name="280" href="#280">280</a>                     className = i.next();
<a class="jxr_linenumber" name="281" href="#281">281</a>                     <a href="../../../../com/p6spy/engine/spy/P6Factory.html">P6Factory</a> factory = (P6Factory) P6Util.forName(className).newInstance();
<a class="jxr_linenumber" name="282" href="#282">282</a>                     factories.add(factory);
<a class="jxr_linenumber" name="283" href="#283">283</a> 
<a class="jxr_linenumber" name="284" href="#284">284</a>                     <a href="../../../../com/p6spy/engine/common/P6Options.html">P6Options</a> options = factory.getOptions();
<a class="jxr_linenumber" name="285" href="#285">285</a>                     <strong class="jxr_keyword">if</strong> (options != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="286" href="#286">286</a>                         OptionReloader.add(options, properties);
<a class="jxr_linenumber" name="287" href="#287">287</a>                     }
<a class="jxr_linenumber" name="288" href="#288">288</a> 
<a class="jxr_linenumber" name="289" href="#289">289</a>                     P6LogQuery.debug(<span class="jxr_string">"Registered factory: "</span> + className + <span class="jxr_string">" with options: "</span> + options);
<a class="jxr_linenumber" name="290" href="#290">290</a>                 }
<a class="jxr_linenumber" name="291" href="#291">291</a>             }
<a class="jxr_linenumber" name="292" href="#292">292</a> 
<a class="jxr_linenumber" name="293" href="#293">293</a>             initialized = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="294" href="#294">294</a> 
<a class="jxr_linenumber" name="295" href="#295">295</a>             <strong class="jxr_keyword">for</strong> (Enumeration&lt;Driver&gt; e = DriverManager.getDrivers(); e.hasMoreElements();) {
<a class="jxr_linenumber" name="296" href="#296">296</a>                 P6LogQuery.debug(<span class="jxr_string">"Driver manager reporting driver registered: "</span> + e.nextElement());
<a class="jxr_linenumber" name="297" href="#297">297</a>             }
<a class="jxr_linenumber" name="298" href="#298">298</a> 
<a class="jxr_linenumber" name="299" href="#299">299</a>         } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="300" href="#300">300</a>             String err = <span class="jxr_string">"Error registering "</span> + classType + <span class="jxr_string">"  ["</span> + className + <span class="jxr_string">"]\nCaused By: "</span> + e.toString();
<a class="jxr_linenumber" name="301" href="#301">301</a>             P6LogQuery.error(err);
<a class="jxr_linenumber" name="302" href="#302">302</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> <a href="../../../../com/p6spy/engine/spy/P6DriverNotFoundError.html">P6DriverNotFoundError</a>(err);
<a class="jxr_linenumber" name="303" href="#303">303</a>         }
<a class="jxr_linenumber" name="304" href="#304">304</a> 
<a class="jxr_linenumber" name="305" href="#305">305</a>     }
<a class="jxr_linenumber" name="306" href="#306">306</a> 
<a class="jxr_linenumber" name="307" href="#307">307</a>     <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> deregister(String className) <strong class="jxr_keyword">throws</strong> SQLException {
<a class="jxr_linenumber" name="308" href="#308">308</a>         List&lt;Driver&gt; dereg = <strong class="jxr_keyword">new</strong> ArrayList&lt;Driver&gt;();
<a class="jxr_linenumber" name="309" href="#309">309</a>         <strong class="jxr_keyword">for</strong> (Enumeration&lt;Driver&gt; e = DriverManager.getDrivers(); e.hasMoreElements();) {
<a class="jxr_linenumber" name="310" href="#310">310</a>             Driver driver = e.nextElement();
<a class="jxr_linenumber" name="311" href="#311">311</a> 
<a class="jxr_linenumber" name="312" href="#312">312</a>             <em class="jxr_comment">// once you reach a P6 driver, you can jump out</em>
<a class="jxr_linenumber" name="313" href="#313">313</a>             <strong class="jxr_keyword">if</strong> (driver instanceof P6SpyDriver) {
<a class="jxr_linenumber" name="314" href="#314">314</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="315" href="#315">315</a>             }
<a class="jxr_linenumber" name="316" href="#316">316</a> 
<a class="jxr_linenumber" name="317" href="#317">317</a>             <em class="jxr_comment">// now you have to be careful of concurrent update</em>
<a class="jxr_linenumber" name="318" href="#318">318</a>             <em class="jxr_comment">// exceptions here, so save the drivers for later</em>
<a class="jxr_linenumber" name="319" href="#319">319</a>             <em class="jxr_comment">// deregistration</em>
<a class="jxr_linenumber" name="320" href="#320">320</a>             <strong class="jxr_keyword">if</strong> (driver.getClass().getName().equals(className)) {
<a class="jxr_linenumber" name="321" href="#321">321</a>                 dereg.add(driver);
<a class="jxr_linenumber" name="322" href="#322">322</a>             }
<a class="jxr_linenumber" name="323" href="#323">323</a>         }
<a class="jxr_linenumber" name="324" href="#324">324</a> 
<a class="jxr_linenumber" name="325" href="#325">325</a>         <em class="jxr_comment">// if you found any drivers let's dereg them now</em>
<a class="jxr_linenumber" name="326" href="#326">326</a>         <strong class="jxr_keyword">int</strong> size = dereg.size();
<a class="jxr_linenumber" name="327" href="#327">327</a>         <strong class="jxr_keyword">if</strong> (size &gt; 0) {
<a class="jxr_linenumber" name="328" href="#328">328</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i = 0; i &lt; size; i++) {
<a class="jxr_linenumber" name="329" href="#329">329</a>                 Driver driver = dereg.get(i);
<a class="jxr_linenumber" name="330" href="#330">330</a>                 <strong class="jxr_keyword">if</strong> (P6SpyOptions.getDeregisterDrivers()) {
<a class="jxr_linenumber" name="331" href="#331">331</a>                     P6LogQuery.info(<span class="jxr_string">"deregistering driver "</span> + driver.getClass().getName());
<a class="jxr_linenumber" name="332" href="#332">332</a>                     DriverManager.deregisterDriver(driver);
<a class="jxr_linenumber" name="333" href="#333">333</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="334" href="#334">334</a>                     <a href="../../../../com/p6spy/engine/common/P6LogQuery.html">P6LogQuery</a>
<a class="jxr_linenumber" name="335" href="#335">335</a>                         .error(<span class="jxr_string">"driver "</span>
<a class="jxr_linenumber" name="336" href="#336">336</a>                             + driver.getClass().getName()
<a class="jxr_linenumber" name="337" href="#337">337</a>                             + <span class="jxr_string">" is a real driver in spy.properties, but it has been loaded before p6spy.  p6spy will not wrap these connections.  Either prevent the driver from loading, or try setting 'deregisterdrivers' to true in spy.properties"</span>);
<a class="jxr_linenumber" name="338" href="#338">338</a>                 }
<a class="jxr_linenumber" name="339" href="#339">339</a>             }
<a class="jxr_linenumber" name="340" href="#340">340</a>         }
<a class="jxr_linenumber" name="341" href="#341">341</a> 
<a class="jxr_linenumber" name="342" href="#342">342</a>     }
<a class="jxr_linenumber" name="343" href="#343">343</a> 
<a class="jxr_linenumber" name="344" href="#344">344</a>     <strong class="jxr_keyword">public</strong> <a href="../../../../com/p6spy/engine/spy/P6SpyDriverCore.html">P6SpyDriverCore</a>(String _spydriver, <a href="../../../../com/p6spy/engine/spy/P6Factory.html">P6Factory</a> _p6factory) <strong class="jxr_keyword">throws</strong> ClassNotFoundException, InstantiationException, IllegalAccessException,
<a class="jxr_linenumber" name="345" href="#345">345</a>             SQLException {
<a class="jxr_linenumber" name="346" href="#346">346</a>         <em class="jxr_comment">// if we couldn't find the spy.properties file, complain here</em>
<a class="jxr_linenumber" name="347" href="#347">347</a>         <strong class="jxr_keyword">if</strong> (!foundSpyProperties) {
<a class="jxr_linenumber" name="348" href="#348">348</a>             <strong class="jxr_keyword">throw</strong> (<strong class="jxr_keyword">new</strong> InstantiationException(<span class="jxr_string">"spy.properties not found in classpath"</span>));
<a class="jxr_linenumber" name="349" href="#349">349</a>         }
<a class="jxr_linenumber" name="350" href="#350">350</a>         <em class="jxr_comment">// should really change the constructor here :)</em>
<a class="jxr_linenumber" name="351" href="#351">351</a>     }
<a class="jxr_linenumber" name="352" href="#352">352</a> 
<a class="jxr_linenumber" name="353" href="#353">353</a>     <em class="jxr_comment">// these methods are the secret sauce here</em>
<a class="jxr_linenumber" name="354" href="#354">354</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> Connection wrapConnection(Connection realConnection) <strong class="jxr_keyword">throws</strong> SQLException {
<a class="jxr_linenumber" name="355" href="#355">355</a>         Connection con = realConnection;
<a class="jxr_linenumber" name="356" href="#356">356</a>         <strong class="jxr_keyword">if</strong> (factories != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="357" href="#357">357</a>             <strong class="jxr_keyword">for</strong> (P6Factory factory : factories) {
<a class="jxr_linenumber" name="358" href="#358">358</a>                 con = factory.getConnection(con);
<a class="jxr_linenumber" name="359" href="#359">359</a>             }
<a class="jxr_linenumber" name="360" href="#360">360</a>         }
<a class="jxr_linenumber" name="361" href="#361">361</a>         <strong class="jxr_keyword">return</strong> con;
<a class="jxr_linenumber" name="362" href="#362">362</a>     }
<a class="jxr_linenumber" name="363" href="#363">363</a> 
<a class="jxr_linenumber" name="364" href="#364">364</a>     <strong class="jxr_keyword">public</strong> Driver getPassthru() {
<a class="jxr_linenumber" name="365" href="#365">365</a>         <strong class="jxr_keyword">return</strong> passthru;
<a class="jxr_linenumber" name="366" href="#366">366</a>     }
<a class="jxr_linenumber" name="367" href="#367">367</a> 
<a class="jxr_linenumber" name="368" href="#368">368</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setPassthru(Driver inVar) {
<a class="jxr_linenumber" name="369" href="#369">369</a>         passthru = inVar;
<a class="jxr_linenumber" name="370" href="#370">370</a>     }
<a class="jxr_linenumber" name="371" href="#371">371</a> 
<a class="jxr_linenumber" name="372" href="#372">372</a>     <strong class="jxr_keyword">private</strong> String getRealUrl(String url) {
<a class="jxr_linenumber" name="373" href="#373">373</a>         <strong class="jxr_keyword">if</strong> (P6SpyOptions.getUsePrefix()) {
<a class="jxr_linenumber" name="374" href="#374">374</a>             <strong class="jxr_keyword">return</strong> url.startsWith(<span class="jxr_string">"p6spy:"</span>) ? url.substring(<span class="jxr_string">"p6spy:"</span>.length()) : <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="375" href="#375">375</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="376" href="#376">376</a>             <strong class="jxr_keyword">return</strong> url;
<a class="jxr_linenumber" name="377" href="#377">377</a>         }
<a class="jxr_linenumber" name="378" href="#378">378</a>     }
<a class="jxr_linenumber" name="379" href="#379">379</a> 
<a class="jxr_linenumber" name="380" href="#380">380</a>     <em class="jxr_comment">// the remaining methods are for the Driver interface</em>
<a class="jxr_linenumber" name="381" href="#381">381</a>     <strong class="jxr_keyword">public</strong> Connection connect(String p0, java.util.Properties p1) <strong class="jxr_keyword">throws</strong> SQLException {
<a class="jxr_linenumber" name="382" href="#382">382</a>         String realUrl = <strong class="jxr_keyword">this</strong>.getRealUrl(p0);
<a class="jxr_linenumber" name="383" href="#383">383</a>         <em class="jxr_comment">// if there is no url, we have problems</em>
<a class="jxr_linenumber" name="384" href="#384">384</a>         <strong class="jxr_keyword">if</strong> (realUrl == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="385" href="#385">385</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> SQLException(<span class="jxr_string">"realURL is null, needs the p6spy prefix: "</span> + p0);
<a class="jxr_linenumber" name="386" href="#386">386</a>         }
<a class="jxr_linenumber" name="387" href="#387">387</a> 
<a class="jxr_linenumber" name="388" href="#388">388</a>         <em class="jxr_comment">// lets try to find the driver from the multiple divers in spy.properties</em>
<a class="jxr_linenumber" name="389" href="#389">389</a>         findPassthru(realUrl);
<a class="jxr_linenumber" name="390" href="#390">390</a>         <em class="jxr_comment">// if we can't find one, it may not be defined</em>
<a class="jxr_linenumber" name="391" href="#391">391</a>         <strong class="jxr_keyword">if</strong> (passthru == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="392" href="#392">392</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> SQLException(<span class="jxr_string">"Unable to find a driver that accepts "</span> + realUrl);
<a class="jxr_linenumber" name="393" href="#393">393</a>         }
<a class="jxr_linenumber" name="394" href="#394">394</a> 
<a class="jxr_linenumber" name="395" href="#395">395</a>         P6LogQuery.debug(<span class="jxr_string">"this is "</span> + <strong class="jxr_keyword">this</strong> + <span class="jxr_string">" and passthru is "</span> + passthru);
<a class="jxr_linenumber" name="396" href="#396">396</a>         <strong class="jxr_keyword">if</strong> (passthru == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="397" href="#397">397</a>             findPassthru(realUrl);
<a class="jxr_linenumber" name="398" href="#398">398</a>         }
<a class="jxr_linenumber" name="399" href="#399">399</a> 
<a class="jxr_linenumber" name="400" href="#400">400</a>         Connection conn = passthru.connect(realUrl, p1);
<a class="jxr_linenumber" name="401" href="#401">401</a> 
<a class="jxr_linenumber" name="402" href="#402">402</a>         <strong class="jxr_keyword">if</strong> (conn != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="403" href="#403">403</a>             conn = wrapConnection(conn);
<a class="jxr_linenumber" name="404" href="#404">404</a>         }
<a class="jxr_linenumber" name="405" href="#405">405</a>         <strong class="jxr_keyword">return</strong> conn;
<a class="jxr_linenumber" name="406" href="#406">406</a>     }
<a class="jxr_linenumber" name="407" href="#407">407</a> 
<a class="jxr_linenumber" name="408" href="#408">408</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> findPassthru(String url) {
<a class="jxr_linenumber" name="409" href="#409">409</a>         <strong class="jxr_keyword">for</strong> (Driver driver : realDrivers) {
<a class="jxr_linenumber" name="410" href="#410">410</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="411" href="#411">411</a>                 <strong class="jxr_keyword">if</strong> (driver.acceptsURL(url)) {
<a class="jxr_linenumber" name="412" href="#412">412</a>                     passthru = driver;
<a class="jxr_linenumber" name="413" href="#413">413</a>                     P6LogQuery.debug(<span class="jxr_string">"found new driver "</span> + driver);
<a class="jxr_linenumber" name="414" href="#414">414</a>                     <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="415" href="#415">415</a>                 }
<a class="jxr_linenumber" name="416" href="#416">416</a>             } <strong class="jxr_keyword">catch</strong> (SQLException e) {
<a class="jxr_linenumber" name="417" href="#417">417</a>             }
<a class="jxr_linenumber" name="418" href="#418">418</a>         }
<a class="jxr_linenumber" name="419" href="#419">419</a>     }
<a class="jxr_linenumber" name="420" href="#420">420</a> 
<a class="jxr_linenumber" name="421" href="#421">421</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="422" href="#422">422</a> <em class="jxr_javadoccomment">     * for some reason the passthru is null, go create one</em>
<a class="jxr_linenumber" name="423" href="#423">423</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="424" href="#424">424</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> acceptsURL(String p0) <strong class="jxr_keyword">throws</strong> SQLException {
<a class="jxr_linenumber" name="425" href="#425">425</a>         String realUrl = <strong class="jxr_keyword">this</strong>.getRealUrl(p0);
<a class="jxr_linenumber" name="426" href="#426">426</a>         <strong class="jxr_keyword">boolean</strong> accepts = false;
<a class="jxr_linenumber" name="427" href="#427">427</a> 
<a class="jxr_linenumber" name="428" href="#428">428</a>         <em class="jxr_comment">// somehow we get initilized but no driver is created,</em>
<a class="jxr_linenumber" name="429" href="#429">429</a>         <em class="jxr_comment">// lets try findPassthru</em>
<a class="jxr_linenumber" name="430" href="#430">430</a>         <strong class="jxr_keyword">if</strong> (passthru == <strong class="jxr_keyword">null</strong> &amp;&amp; initialized) {
<a class="jxr_linenumber" name="431" href="#431">431</a>             <em class="jxr_comment">// we should have some drivers</em>
<a class="jxr_linenumber" name="432" href="#432">432</a>             <strong class="jxr_keyword">if</strong> (realDrivers.size() == 0) {
<a class="jxr_linenumber" name="433" href="#433">433</a>                 <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> SQLException(<span class="jxr_string">"P6 has no drivers registered"</span>);
<a class="jxr_linenumber" name="434" href="#434">434</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="435" href="#435">435</a>                 findPassthru(realUrl);
<a class="jxr_linenumber" name="436" href="#436">436</a>                 <em class="jxr_comment">// if we are still null, we have issues</em>
<a class="jxr_linenumber" name="437" href="#437">437</a>                 <strong class="jxr_keyword">if</strong> (passthru == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="438" href="#438">438</a>                     <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> SQLException(<span class="jxr_string">"P6 can't find a driver to accept url ("</span> + realUrl + <span class="jxr_string">") from the "</span> + realDrivers.size()
<a class="jxr_linenumber" name="439" href="#439">439</a>                         + <span class="jxr_string">" drivers P6 knows about. The current driver is null"</span>);
<a class="jxr_linenumber" name="440" href="#440">440</a>                 }
<a class="jxr_linenumber" name="441" href="#441">441</a>             }
<a class="jxr_linenumber" name="442" href="#442">442</a>         }
<a class="jxr_linenumber" name="443" href="#443">443</a> 
<a class="jxr_linenumber" name="444" href="#444">444</a>         <strong class="jxr_keyword">if</strong> (realUrl != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="445" href="#445">445</a>             accepts = passthru.acceptsURL(realUrl);
<a class="jxr_linenumber" name="446" href="#446">446</a>         }
<a class="jxr_linenumber" name="447" href="#447">447</a>         <strong class="jxr_keyword">return</strong> accepts;
<a class="jxr_linenumber" name="448" href="#448">448</a>     }
<a class="jxr_linenumber" name="449" href="#449">449</a> 
<a class="jxr_linenumber" name="450" href="#450">450</a>     <strong class="jxr_keyword">public</strong> DriverPropertyInfo[] getPropertyInfo(String p0, java.util.Properties p1) <strong class="jxr_keyword">throws</strong> SQLException {
<a class="jxr_linenumber" name="451" href="#451">451</a>         <strong class="jxr_keyword">return</strong> (passthru.getPropertyInfo(p0, p1));
<a class="jxr_linenumber" name="452" href="#452">452</a>     }
<a class="jxr_linenumber" name="453" href="#453">453</a> 
<a class="jxr_linenumber" name="454" href="#454">454</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> getMajorVersion() {
<a class="jxr_linenumber" name="455" href="#455">455</a>         <strong class="jxr_keyword">return</strong> (passthru.getMajorVersion());
<a class="jxr_linenumber" name="456" href="#456">456</a>     }
<a class="jxr_linenumber" name="457" href="#457">457</a> 
<a class="jxr_linenumber" name="458" href="#458">458</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> getMinorVersion() {
<a class="jxr_linenumber" name="459" href="#459">459</a>         <strong class="jxr_keyword">return</strong> (passthru.getMinorVersion());
<a class="jxr_linenumber" name="460" href="#460">460</a>     }
<a class="jxr_linenumber" name="461" href="#461">461</a> 
<a class="jxr_linenumber" name="462" href="#462">462</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> jdbcCompliant() {
<a class="jxr_linenumber" name="463" href="#463">463</a>         <strong class="jxr_keyword">return</strong> (passthru.jdbcCompliant());
<a class="jxr_linenumber" name="464" href="#464">464</a>     }
<a class="jxr_linenumber" name="465" href="#465">465</a> 
<a class="jxr_linenumber" name="466" href="#466">466</a>     <em class="jxr_comment">// since 1.7</em>
<a class="jxr_linenumber" name="467" href="#467">467</a>     @Override
<a class="jxr_linenumber" name="468" href="#468">468</a>     <strong class="jxr_keyword">public</strong> Logger getParentLogger() <strong class="jxr_keyword">throws</strong> SQLFeatureNotSupportedException {
<a class="jxr_linenumber" name="469" href="#469">469</a>         <strong class="jxr_keyword">return</strong> passthru.getParentLogger();
<a class="jxr_linenumber" name="470" href="#470">470</a>     }
<a class="jxr_linenumber" name="471" href="#471">471</a> }
</pre>
<hr/><div id="footer">This page was automatically generated by <a href="http://maven.apache.org/">Maven</a></div></body>
</html>

